<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO WebSocket í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script> 
</head>
<body>
    <h1>Socket.IO WebSocket í…ŒìŠ¤íŠ¸</h1>
    <button onclick="connectSocket()">ğŸ”— Socket.IO ì—°ê²°</button>
    <button onclick="disconnectSocket()">âŒ ì—°ê²° ì¢…ë£Œ</button>
    <div id="log"></div>

    <script>
        let socket;
    
        function logMessage(message) {
            document.getElementById("log").innerHTML += `<p>${message}</p>`;
        }

        function connectSocket() {
            const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJlamppMDAwMUBnbWFpbC5jb20iLCJhZG1pbiI6MSwiZXhwIjoxNzM5MjkyNjczfQ._GU-5KWIj4qZutTfgpYbPJ-zAT3GPQa3kIJ9fCvAmYU";

            // âœ… FastAPI Socket.IO ì„œë²„ì— ì—°ê²°
            socket = io("http://localhost:8000", {
                path: "/socket.io",
                transports: ["websocket"],
                query: { token: token }
            });

            // âœ… ì—°ê²° ì„±ê³µ
            socket.on("connect", () => {
                logMessage(`âœ… <b>Socket.IO ì—°ê²° ì„±ê³µ!</b> (ID: ${socket.id})`);
            });

            // âœ… ì„œë²„ì—ì„œ ë©”ì‹œì§€ë¥¼ ë°›ì„ ë•Œ ì‹¤í–‰
            socket.on("message", (data) => {
                logMessage(`ğŸ“© <b>ì„œë²„ ë©”ì‹œì§€:</b> ${JSON.stringify(data)}`);
            });

            // âœ… ìƒˆë¡œìš´ ê²Œì‹œê¸€ ì•Œë¦¼
            socket.on("newPost", (post) => {
                logMessage(`ğŸ†• <b>ìƒˆ ê²Œì‹œê¸€:</b> ${post.post_title} - ${post.post_text}`);
                addPostToLog(post);
            });

            // âœ… ê²Œì‹œê¸€ ìˆ˜ì • ì•Œë¦¼
            socket.on("updatedPost", (post) => {
                logMessage(`âœï¸ <b>ê²Œì‹œê¸€ ìˆ˜ì •ë¨:</b> ${post.post_title}`);
                addPostToLog(post);
            });

            // âœ… ìƒˆë¡œìš´ ëŒ“ê¸€ ì•Œë¦¼
            socket.on("newComment", (comment) => {
                logMessage(`ğŸ’¬ <b>ìƒˆ ëŒ“ê¸€:</b> ${comment.comment} (ì‘ì„±ì: ${comment.user_email})`);
                addCommentToLog(comment);
            });

            // âœ… ëŒ“ê¸€ ì‚­ì œ ì•Œë¦¼
            socket.on("deletedComment", (comment) => {
                logMessage(`âŒ <b>ëŒ“ê¸€ ì‚­ì œë¨:</b> ëŒ“ê¸€ ID ${comment.comment_id} (ê²Œì‹œê¸€ ID: ${comment.post_id})`);
                removeCommentFromLog(comment.comment_id);
            });

            // âœ… ìƒˆë¡œìš´ ê´€ë¦¬ì ë‹µë³€ ì•Œë¦¼
            socket.on("newAnswer", (answer) => {
                logMessage(`ğŸ”µ <b>ê´€ë¦¬ì ë‹µë³€ ì¶”ê°€:</b> ${answer.ans_text}`);
                addAnswerToLog(answer);
            });

            // âœ… ê´€ë¦¬ì ë‹µë³€ ì‚­ì œ ì•Œë¦¼
            socket.on("deletedAnswer", (answer) => {
                logMessage(`âš ï¸ <b>ê´€ë¦¬ì ë‹µë³€ ì‚­ì œë¨:</b> ë‹µë³€ ID ${answer.answer_id} (ê²Œì‹œê¸€ ID: ${answer.post_id})`);
                removeAnswerFromLog(answer.answer_id);
            });

            // âœ… ì—°ê²° í•´ì œ ì´ë²¤íŠ¸
            socket.on("disconnect", () => {
                logMessage("âŒ <b>Socket.IO ì—°ê²° ì¢…ë£Œ</b>");
            });

            // âœ… ì—°ê²° ì˜¤ë¥˜ ë°œìƒ ì‹œ ì²˜ë¦¬
            socket.on("connect_error", (error) => {
                logMessage("âŒ <b>Socket.IO ì—°ê²° ì˜¤ë¥˜ ë°œìƒ:</b> " + error.message);
                console.error(error);
            });
        }

        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                logMessage("âŒ <b>ìˆ˜ë™ìœ¼ë¡œ ì—°ê²° ì¢…ë£Œ</b>");
            }
        }

        // âœ… ìƒˆë¡œìš´ ê²Œì‹œê¸€ì„ ë¡œê·¸ì— ì¶”ê°€
        function addPostToLog(post) {
            const logDiv = document.getElementById("log");
            const newPostElement = document.createElement("div");
            newPostElement.innerHTML = `
                <h3>ğŸ“ ${post.post_title}</h3>
                <p>${post.post_text}</p>
                <small>ì‘ì„±ì: ${post.user_email} | ì‹œê°„: ${post.post_time}</small>
                <hr>
            `;
            logDiv.prepend(newPostElement);  // ìµœì‹  ê²Œì‹œê¸€ì´ ìœ„ë¡œ ì˜¤ë„ë¡ ì¶”ê°€
        }

        // âœ… ìƒˆë¡œìš´ ëŒ“ê¸€ì„ ë¡œê·¸ì— ì¶”ê°€
        function addCommentToLog(comment) {
            const logDiv = document.getElementById("log");
            const newCommentElement = document.createElement("div");
            newCommentElement.id = `comment-${comment.comment_id}`;
            newCommentElement.innerHTML = `
                <p>ğŸ’¬ <b>${comment.user_email}:</b> ${comment.comment} <small>(${comment.comment_date})</small></p>
            `;
            logDiv.prepend(newCommentElement);
        }

        // âœ… ëŒ“ê¸€ ì‚­ì œ ì‹œ ë¡œê·¸ì—ì„œ ì œê±°
        function removeCommentFromLog(comment_id) {
            const commentElement = document.getElementById(`comment-${comment_id}`);
            if (commentElement) {
                commentElement.remove();
                logMessage(`ğŸ—‘ï¸ ëŒ“ê¸€ ID ${comment_id}ê°€ ì‚­ì œë¨`);
            }
        }

        // âœ… ìƒˆë¡œìš´ ê´€ë¦¬ì ë‹µë³€ì„ ë¡œê·¸ì— ì¶”ê°€
        function addAnswerToLog(answer) {
            const logDiv = document.getElementById("log");
            const newAnswerElement = document.createElement("div");
            newAnswerElement.id = `answer-${answer.ans_id}`;
            newAnswerElement.innerHTML = `
                <p>ğŸ› ï¸ <b>ê´€ë¦¬ì ë‹µë³€:</b> ${answer.ans_text} <small>(${answer.ans_date})</small></p>
            `;
            logDiv.prepend(newAnswerElement);
        }

        // âœ… ê´€ë¦¬ì ë‹µë³€ ì‚­ì œ ì‹œ ë¡œê·¸ì—ì„œ ì œê±°
        function removeAnswerFromLog(answer_id) {
            const answerElement = document.getElementById(`answer-${answer_id}`);
            if (answerElement) {
                answerElement.remove();
                logMessage(`ğŸ—‘ï¸ ê´€ë¦¬ì ë‹µë³€ ID ${answer_id}ê°€ ì‚­ì œë¨`);
            }
        }
    </script>
</body>
</html>
